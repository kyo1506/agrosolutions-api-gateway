---
# API Gateway ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: api-gateway-config
  namespace: agrosolutions-gateway
data:
  ASPNETCORE_ENVIRONMENT: "Production"
  ASPNETCORE_URLS: "http://*:80"
  AllowedHosts: "*"

  # JWT Configuration
  Jwt__Authority: "http://keycloak-service.agrosolutions-identity:8080/realms/agrosolutions"
  Jwt__Audience: "agrosolutions-api"
  Jwt__ExternalAuthority: "http://keycloak-admin.agrosolutions.site/realms/agrosolutions"

  # OpenTelemetry Configuration (OTel Collector j√° sobe no agrosolutions-observability via service-identity)
  OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector-service.agrosolutions-observability:4317"
  OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
  OTEL_SERVICE_NAME: "agrosolutions-api-gateway"
  OTEL_RESOURCE_ATTRIBUTES: "deployment.environment=production,service.version=1.0.0"
  OTEL_TRACES_EXPORTER: "otlp"
  OTEL_METRICS_EXPORTER: "otlp"
  OTEL_LOGS_EXPORTER: "otlp"

  # Serilog Configuration
  Serilog__MinimumLevel__Default: "Information"
  Serilog__MinimumLevel__Override__Microsoft: "Warning"
  Serilog__MinimumLevel__Override__System: "Warning"

---
# Ocelot Configuration ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: ocelot-config
  namespace: agrosolutions-gateway
data:
  ocelot.json: |
    {
      "Routes": [
        {
          "Key": "identity-login",
          "DownstreamPathTemplate": "/v1/login",
          "DownstreamScheme": "http",
          "DownstreamHostAndPorts": [{ "Host": "identity-api-service.agrosolutions-identity", "Port": 80 }],
          "UpstreamPathTemplate": "/identity/v1/login",
          "UpstreamHttpMethod": ["POST"],
          "RateLimitOptions": { "EnableRateLimiting": true, "Period": "1m", "Limit": 30 },
          "QoSOptions": { "ExceptionsAllowedBeforeBreaking": 3, "DurationOfBreak": 30000, "TimeoutValue": 10000 }
        },
        {
          "Key": "identity-register",
          "DownstreamPathTemplate": "/v1/register",
          "DownstreamScheme": "http",
          "DownstreamHostAndPorts": [{ "Host": "identity-api-service.agrosolutions-identity", "Port": 80 }],
          "UpstreamPathTemplate": "/identity/v1/register",
          "UpstreamHttpMethod": ["POST"],
          "RateLimitOptions": { "EnableRateLimiting": true, "Period": "1m", "Limit": 20 },
          "QoSOptions": { "ExceptionsAllowedBeforeBreaking": 3, "DurationOfBreak": 30000, "TimeoutValue": 10000 }
        },
        {
          "Key": "identity-users-list",
          "DownstreamPathTemplate": "/v1/users",
          "DownstreamScheme": "http",
          "DownstreamHostAndPorts": [{ "Host": "identity-api-service.agrosolutions-identity", "Port": 80 }],
          "UpstreamPathTemplate": "/identity/v1/users",
          "UpstreamHttpMethod": ["GET"],
          "AuthenticationOptions": { "AuthenticationProviderKey": "Bearer" },
          "RouteClaimsRequirement": { "scope": "users:manage" },
          "RateLimitOptions": { "EnableRateLimiting": true, "Period": "1m", "Limit": 100 },
          "QoSOptions": { "ExceptionsAllowedBeforeBreaking": 3, "DurationOfBreak": 30000, "TimeoutValue": 10000 }
        },
        {
          "Key": "identity-user-get-by-id",
          "DownstreamPathTemplate": "/v1/users/{id}",
          "DownstreamScheme": "http",
          "DownstreamHostAndPorts": [{ "Host": "identity-api-service.agrosolutions-identity", "Port": 80 }],
          "UpstreamPathTemplate": "/identity/v1/users/{id}",
          "UpstreamHttpMethod": ["GET"],
          "Priority": 1,
          "AuthenticationOptions": { "AuthenticationProviderKey": "Bearer" },
          "RouteClaimsRequirement": { "scope": "users:read" },
          "RateLimitOptions": { "EnableRateLimiting": true, "Period": "1m", "Limit": 100 },
          "QoSOptions": { "ExceptionsAllowedBeforeBreaking": 3, "DurationOfBreak": 30000, "TimeoutValue": 10000 }
        },
        {
          "Key": "identity-user-update",
          "DownstreamPathTemplate": "/v1/users/{id}",
          "DownstreamScheme": "http",
          "DownstreamHostAndPorts": [{ "Host": "identity-api-service.agrosolutions-identity", "Port": 80 }],
          "UpstreamPathTemplate": "/identity/v1/users/{id}",
          "UpstreamHttpMethod": ["PUT"],
          "Priority": 1,
          "AuthenticationOptions": { "AuthenticationProviderKey": "Bearer" },
          "RouteClaimsRequirement": { "scope": "users:manage" },
          "RateLimitOptions": { "EnableRateLimiting": true, "Period": "1m", "Limit": 100 },
          "QoSOptions": { "ExceptionsAllowedBeforeBreaking": 3, "DurationOfBreak": 30000, "TimeoutValue": 10000 }
        },
        {
          "Key": "identity-user-delete",
          "DownstreamPathTemplate": "/v1/users/{id}",
          "DownstreamScheme": "http",
          "DownstreamHostAndPorts": [{ "Host": "identity-api-service.agrosolutions-identity", "Port": 80 }],
          "UpstreamPathTemplate": "/identity/v1/users/{id}",
          "UpstreamHttpMethod": ["DELETE"],
          "Priority": 1,
          "AuthenticationOptions": { "AuthenticationProviderKey": "Bearer" },
          "RouteClaimsRequirement": { "scope": "users:manage" },
          "RateLimitOptions": { "EnableRateLimiting": true, "Period": "1m", "Limit": 100 },
          "QoSOptions": { "ExceptionsAllowedBeforeBreaking": 3, "DurationOfBreak": 30000, "TimeoutValue": 10000 }
        },
        {
          "Key": "identity-profile",
          "DownstreamPathTemplate": "/v1/profile",
          "DownstreamScheme": "http",
          "DownstreamHostAndPorts": [{ "Host": "identity-api-service.agrosolutions-identity", "Port": 80 }],
          "UpstreamPathTemplate": "/identity/v1/profile",
          "UpstreamHttpMethod": ["GET", "PUT"],
          "AuthenticationOptions": { "AuthenticationProviderKey": "Bearer" },
          "RouteClaimsRequirement": { "scope": "profiles:manage" },
          "RateLimitOptions": { "EnableRateLimiting": true, "Period": "1m", "Limit": 100 },
          "QoSOptions": { "ExceptionsAllowedBeforeBreaking": 3, "DurationOfBreak": 30000, "TimeoutValue": 10000 }
        },
        {
          "Key": "ingestao-sensor",
          "DownstreamPathTemplate": "/api/ingestion/sensor",
          "DownstreamScheme": "http",
          "DownstreamHostAndPorts": [{ "Host": "ingestion-api-service.agrosolutions-ingestion", "Port": 80 }],
          "UpstreamPathTemplate": "/ingestao/sensor",
          "UpstreamHttpMethod": ["POST"],
          "RateLimitOptions": { "EnableRateLimiting": true, "Period": "1s", "Limit": 5000 },
          "QoSOptions": { "ExceptionsAllowedBeforeBreaking": 10, "DurationOfBreak": 5000, "TimeoutValue": 3000 },
          "LoadBalancerOptions": { "Type": "LeastConnection" }
        },
        {
          "Key": "properties-read",
          "DownstreamPathTemplate": "/v1/{everything}",
          "DownstreamScheme": "http",
          "DownstreamHostAndPorts": [{ "Host": "properties-api-service.agrosolutions-properties", "Port": 80 }],
          "UpstreamPathTemplate": "/properties/v1/{everything}",
          "UpstreamHttpMethod": ["GET"],
          "AuthenticationOptions": { "AuthenticationProviderKey": "Bearer" },
          "RouteClaimsRequirement": { "scope": "users:read" },
          "RateLimitOptions": { "EnableRateLimiting": true, "Period": "1m", "Limit": 200 },
          "QoSOptions": { "ExceptionsAllowedBeforeBreaking": 3, "DurationOfBreak": 30000, "TimeoutValue": 10000 },
          "LoadBalancerOptions": { "Type": "RoundRobin" }
        },
        {
          "Key": "properties-write",
          "DownstreamPathTemplate": "/v1/{everything}",
          "DownstreamScheme": "http",
          "DownstreamHostAndPorts": [{ "Host": "properties-api-service.agrosolutions-properties", "Port": 80 }],
          "UpstreamPathTemplate": "/properties/v1/{everything}",
          "UpstreamHttpMethod": ["POST", "PUT", "DELETE"],
          "AuthenticationOptions": { "AuthenticationProviderKey": "Bearer" },
          "RouteClaimsRequirement": { "scope": "users:manage" },
          "RateLimitOptions": { "EnableRateLimiting": true, "Period": "1m", "Limit": 100 },
          "QoSOptions": { "ExceptionsAllowedBeforeBreaking": 3, "DurationOfBreak": 30000, "TimeoutValue": 10000 },
          "LoadBalancerOptions": { "Type": "RoundRobin" }
        }
      ],
      "GlobalConfiguration": {
        "BaseUrl": "http://api.agrosolutions.site",
        "RateLimitOptions": {
          "DisableRateLimitHeaders": false,
          "QuotaExceededMessage": "Rate limit exceeded. Please try again later.",
          "HttpStatusCode": 429,
          "ClientIdHeader": "X-Forwarded-For"
        }
      }
    }
